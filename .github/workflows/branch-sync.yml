name: Branch Sync & Dependency Cascade

on:
  push:
    branches:
      - 'fb_*_dev'    # ONLY feature branches for dev
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    branches:
      - 'dev'
      - 'staging'
      - 'main'
      - 'internal-prod'

permissions:
  contents: write
  pull-requests: write
  statuses: write
  checks: write

env:
  PROMOTION_CHAIN: "dev,staging,main,internal-prod"

jobs:
  create-sync-prs:
    name: Auto PR Creation for Higher Envs
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse branch
        id: parse
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

          # Pattern = fb_<lob>_dev ONLY
          if [[ "$BRANCH" =~ ^fb_([^_]+)_dev$ ]]; then
            LOB="${BASH_REMATCH[1]}"
            echo "lob=${LOB}" >> $GITHUB_OUTPUT
          else
            echo "❌ Branch does not match fb_<lob>_dev pattern."
            echo "lob=UNKNOWN" >> $GITHUB_OUTPUT
          fi

      - name: Abort if invalid branch
        if: steps.parse.outputs.lob == 'UNKNOWN'
        run: exit 0

      - name: Set up git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create PRs for staging → main → internal-prod
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = process.env.GITHUB_REF.replace('refs/heads/', '');
            const chain = ["dev","staging","main","internal-prod"];

            // always treat source env as 'dev'
            const env = "dev"; 
            const match = branch.match(/^fb_([^_]+)_dev$/);
            const lob = match[1];

            const currentIndex = chain.indexOf(env);
            const higherEnvs = chain.slice(currentIndex + 1);

            const execSync = require('child_process').execSync;

            for (const nextEnv of higherEnvs) {
              const syncBranch = `fb_${lob}_sync_${nextEnv}`;
              const targetBranch = nextEnv;
              const title = `[auto-sync] ${branch} → ${targetBranch}`;
              const body = `Automated sync PR from **${branch}** → **${targetBranch}**.\nSync branch: \`${syncBranch}\``;

              execSync(`git fetch origin ${branch} ${targetBranch} || true`, {stdio: 'inherit'});
              const sha = execSync(`git rev-parse origin/${branch}`).toString().trim();
              execSync(`git push origin ${sha}:refs/heads/${syncBranch} --force`, {stdio: 'inherit'});

              const prs = await github.rest.pulls.list({
                owner, repo, head: `${owner}:${syncBranch}`, base: targetBranch, state: 'open'
              });

              if (prs.data.length === 0) {
                await github.rest.pulls.create({
                  owner, repo, title, head: syncBranch, base: targetBranch, body
                });
              }
            }

  dependency-check:
    name: My Merge Sequence Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine dependency
        id: dep
        run: |
          TARGET="${{ github.event.pull_request.base.ref }}"
          CHAIN=(dev staging main internal-prod)
          DEP=""
          for i in "${!CHAIN[@]}"; do
            if [[ "${CHAIN[$i]}" == "$TARGET" && $i -gt 0 ]]; then
              DEP="${CHAIN[$((i-1))]}"
            fi
          done
          echo "dependency=${DEP}" >> $GITHUB_OUTPUT

      - name: Validate dependency merged
        run: |
          DEP="${{ steps.dep.outputs.dependency }}"
          TARGET="${{ github.event.pull_request.base.ref }}"

          if [ -z "$DEP" ]; then
            echo "No dependency needed for ${TARGET}"
            exit 0
          fi

          git fetch origin ${DEP} ${TARGET}

          if git merge-base --is-ancestor origin/${DEP} origin/${TARGET}; then
            echo "Dependency OK"
          else
            echo "❌ Dependency NOT satisfied: ${DEP} not merged into ${TARGET}"
            exit 1
          fi